#!/usr/bin/env bash
# ii-niri setup - Simplified installer
# Commands: install, update, doctor, rollback (or TUI if no args)

cd "$(dirname "$0")"
REPO_ROOT="$(pwd)"

# Handle Ctrl+C gracefully
cleanup() {
    echo ""
    echo -e "\033[33mCancelled.\033[0m"
    rm -rf /tmp/buildyay /tmp/buildparu 2>/dev/null
    exit 130
}
trap cleanup INT
trap 'rm -rf /tmp/buildyay /tmp/buildparu 2>/dev/null' EXIT TERM

# Load core libraries
source ./sdata/lib/environment-variables.sh
source ./sdata/lib/functions.sh
source ./sdata/lib/package-installers.sh
source ./sdata/lib/dist-determine.sh
source ./sdata/lib/conflicts.sh
source ./sdata/lib/versioning.sh    # Must be before migrations.sh
source ./sdata/lib/migrations.sh
source ./sdata/lib/robust-update.sh
source ./sdata/lib/doctor.sh
source ./sdata/lib/snapshots.sh

prevent_sudo_or_root

trap 'rm -rf /tmp/buildyay /tmp/buildparu 2>/dev/null' EXIT INT TERM

# Defaults
ask=true
quiet=false

###############################################################################
# Help
###############################################################################
show_help() {
    cat << 'EOF'
ii-niri setup

Usage: ./setup [command] [options]

Commands:
  (none)     Interactive menu
  install    Full installation (deps + config + files)
  update     Check remote, pull, sync, restart shell
  doctor     Diagnose and fix problems
  rollback   Restore previous snapshot

Options:
  -y, --yes     Skip prompts (auto-yes)
  -q, --quiet   Minimal output
  -h, --help    Show this help

Examples:
  ./setup              # Interactive menu
  ./setup update       # Check for updates and apply
  ./setup rollback     # Restore previous state
EOF
}

###############################################################################
# TUI
###############################################################################
tui_menu() {
    clear
    echo -e "${STY_CYAN}${STY_BOLD}"
    cat << 'BANNER'
╔══════════════════════════════════════════╗
║       ii-niri Setup & Management         ║
╚══════════════════════════════════════════╝
BANNER
    echo -e "${STY_RST}"
    
    # Detect current state
    local is_installed=false
    [[ -f "${XDG_CONFIG_HOME}/illogical-impulse/installed_true" ]] && is_installed=true
    
    if $is_installed; then
        local installed_ver=$(get_installed_version)
        local repo_ver=$(get_repo_version)
        echo -e "  Installed: ${STY_GREEN}${installed_ver}${STY_RST}"
        echo -e "  Available: ${STY_CYAN}${repo_ver}${STY_RST}"
        echo ""
    fi
    
    # Menu
    if command -v gum &>/dev/null; then
        local choice
        if $is_installed; then
            choice=$(gum choose --header "What would you like to do?" \
                "Update" "Doctor" "Rollback" "Reinstall" "Help" "Exit")
        else
            choice=$(gum choose --header "What would you like to do?" \
                "Install" "Help" "Exit")
        fi
    else
        echo "Select an option:"
        if $is_installed; then
            select choice in "Update" "Doctor" "Rollback" "Reinstall" "Help" "Exit"; do break; done
        else
            select choice in "Install" "Help" "Exit"; do break; done
        fi
    fi
    
    case "$choice" in
        Install|Reinstall) run_install ;;
        Update) run_update ;;
        Doctor) run_doctor ;;
        Rollback) run_rollback ;;
        Help) show_help; exit 0 ;;
        *) exit 0 ;;
    esac
}

###############################################################################
# Install
###############################################################################
run_install() {
    detect_distro
    
    # Greeting & system info
    source ./sdata/subcmd-install/0.greeting.sh
    
    # Check conflicts
    check_conflicts
    
    # 1. Dependencies
    if [[ "${SKIP_DEPS}" != "true" ]]; then
        source ./sdata/subcmd-install/1.deps-router.sh
    fi
    
    # 2. System setup (groups, services)
    if [[ "${SKIP_SETUPS}" != "true" ]]; then
        source ./sdata/subcmd-install/2.setups.sh
    fi
    
    # 3. Config files
    if [[ "${SKIP_FILES}" != "true" ]]; then
        source ./sdata/subcmd-install/3.files.sh
    fi
    
    # Set version tracking
    set_installed_version "$(get_repo_version)" "$(get_repo_commit)" "setup"
}

###############################################################################
# Update
###############################################################################
run_update() {
    # Check for remote updates first
    echo -e "${STY_FAINT}Checking for updates...${STY_RST}"
    
    if check_remote_updates; then
        show_pending_commits
        
        if $ask; then
            read -p "Pull and apply these updates? [Y/n] " -n 1 -r
            echo
            [[ $REPLY =~ ^[Nn]$ ]] && { echo "Cancelled."; return 0; }
        fi
        
        # Create snapshot BEFORE pulling
        log_info "Creating snapshot..."
        local remote_commit=$(get_remote_commit)
        local snapshot_id=$(create_snapshot "update" "Before update to ${remote_commit}" "$remote_commit")
        echo -e "${STY_GREEN}✓ Snapshot created: ${snapshot_id}${STY_RST}"
        
        # Pull changes
        log_info "Pulling changes..."
        git -C "$REPO_ROOT" pull --ff-only origin 2>/dev/null || {
            log_error "Git pull failed. You may have local changes."
            echo -e "${STY_YELLOW}Run: git stash && ./setup update${STY_RST}"
            return 1
        }
    else
        # Check if local repo is ahead of installed
        local installed_ver=$(get_installed_version)
        local installed_commit=$(get_installed_commit)
        local repo_ver=$(get_repo_version)
        local repo_commit=$(get_repo_commit)
        
        if [[ "$installed_ver" == "0.0.0" ]] && [[ -f "${XDG_CONFIG_HOME}/illogical-impulse/installed_true" ]]; then
            log_info "Detected existing installation without version tracking"
        elif [[ "$installed_commit" == "$repo_commit" ]]; then
            echo -e "${STY_GREEN}✓ Already up to date${STY_RST} ($installed_ver)"
            
            local pending=$(count_pending_migrations)
            if [[ "$pending" -gt 0 ]]; then
                echo -e "${STY_YELLOW}$pending pending migration(s) available${STY_RST}"
                if $ask; then
                    read -p "Apply migrations now? [Y/n] " -n 1 -r
                    echo
                    [[ ! $REPLY =~ ^[Nn]$ ]] && run_migrations_interactive
                fi
            fi
            return 0
        else
            # Local repo ahead of installed - create snapshot
            log_info "Creating snapshot..."
            local snapshot_id=$(create_snapshot "update" "Before sync to ${repo_commit}" "$repo_commit")
            echo -e "${STY_GREEN}✓ Snapshot created: ${snapshot_id}${STY_RST}"
        fi
    fi
    
    # Now sync the files
    local repo_ver=$(get_repo_version)
    local repo_commit=$(get_repo_commit)
    
    echo -e "${STY_CYAN}Syncing ii-niri...${STY_RST}"
    
    II_SOURCE="${REPO_ROOT}"
    II_TARGET="${XDG_CONFIG_HOME}/quickshell/ii"
    
    # Check if source and target are the same (dev setup)
    local src_real=$(realpath "$II_SOURCE" 2>/dev/null || echo "$II_SOURCE")
    local tgt_real=$(realpath "$II_TARGET" 2>/dev/null || echo "$II_TARGET")
    
    if [[ "$src_real" != "$tgt_real" ]]; then
        # Sync root QML files
        for qml in "${II_SOURCE}"/*.qml; do
            [[ -f "$qml" ]] && cp -f "$qml" "${II_TARGET}/$(basename "$qml")"
        done
        
        # Sync directories
        for dir in modules services scripts assets translations; do
            [[ -d "${II_SOURCE}/${dir}" ]] && rsync -a --delete "${II_SOURCE}/${dir}/" "${II_TARGET}/${dir}/"
        done
        
        # Sync other files
        [[ -f "${II_SOURCE}/requirements.txt" ]] && cp -f "${II_SOURCE}/requirements.txt" "${II_TARGET}/"
    fi
    
    # Generate manifest
    generate_manifest "$II_SOURCE" "${II_TARGET}/.ii-manifest"
    
    # Fix permissions
    find "$II_TARGET/scripts" \( -name "*.sh" -o -name "*.fish" -o -name "*.py" \) -exec chmod +x {} \; 2>/dev/null || true
    
    # Update version
    set_installed_version "$repo_ver" "$repo_commit" "update"
    
    echo -e "${STY_GREEN}✓ Update complete${STY_RST}"
    
    # Migrations
    local pending=$(count_pending_migrations)
    if [[ "$pending" -gt 0 ]]; then
        echo ""
        echo -e "${STY_YELLOW}$pending optional migration(s) available${STY_RST}"
        if $ask; then
            read -p "Review and apply? [Y/n] " -n 1 -r
            echo
            [[ ! $REPLY =~ ^[Nn]$ ]] && run_migrations_interactive
        fi
    fi
    
    # Restart shell
    echo ""
    log_info "Restarting shell..."
    qs kill -c ii 2>/dev/null || true
    sleep 1
    nohup qs -c ii >/dev/null 2>&1 &
    disown
    echo -e "${STY_GREEN}✓ Shell restarted${STY_RST}"
    
    echo ""
    echo -e "${STY_FAINT}Tip: Run './setup rollback' if something breaks${STY_RST}"
}

###############################################################################
# Doctor (delegates to doctor.sh but with fixes)
###############################################################################
run_doctor() {
    run_doctor_with_fixes
}

###############################################################################
# Parse args
###############################################################################
COMMAND=""
while [[ $# -gt 0 ]]; do
    case $1 in
        install) COMMAND="install"; shift ;;
        update) COMMAND="update"; shift ;;
        doctor) COMMAND="doctor"; shift ;;
        rollback) COMMAND="rollback"; shift ;;
        -y|--yes) ask=false; shift ;;
        -q|--quiet) quiet=true; shift ;;
        -h|--help) show_help; exit 0 ;;
        *) echo "Unknown: $1"; show_help; exit 1 ;;
    esac
done

###############################################################################
# Run
###############################################################################
case "$COMMAND" in
    install) run_install ;;
    update) run_update ;;
    doctor) run_doctor ;;
    rollback) run_rollback ;;
    "") tui_menu ;;
esac
