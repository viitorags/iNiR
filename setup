#!/usr/bin/env bash
# ii-niri setup - Simplified installer
# Commands: install, update, doctor, rollback (or TUI if no args)

cd "$(dirname "$0")"
REPO_ROOT="$(pwd)"

# Handle Ctrl+C gracefully
cleanup() {
    echo ""
    echo -e "\033[33mCancelled.\033[0m"
    rm -rf /tmp/buildyay /tmp/buildparu 2>/dev/null
    exit 130
}
trap cleanup INT
trap 'rm -rf /tmp/buildyay /tmp/buildparu 2>/dev/null' EXIT TERM

# Load core libraries
source ./sdata/lib/environment-variables.sh
source ./sdata/lib/functions.sh
source ./sdata/lib/tui.sh
source ./sdata/lib/package-installers.sh
source ./sdata/lib/dist-determine.sh
source ./sdata/lib/conflicts.sh
source ./sdata/lib/versioning.sh
source ./sdata/lib/migrations.sh
source ./sdata/lib/robust-update.sh
source ./sdata/lib/doctor.sh
source ./sdata/lib/snapshots.sh

prevent_sudo_or_root

# Defaults
ask=true
quiet=false

###############################################################################
# Help
###############################################################################
show_help() {
    echo ""
    tui_title "ii-niri setup"
    echo ""
    echo "Usage: ./setup [command] [options]"
    echo ""
    tui_subtitle "Commands:"
    echo "  (none)     Interactive menu"
    echo "  install    Full installation (deps + config + files)"
    echo "  update     Check remote, pull, sync, restart shell"
    echo "  doctor     Diagnose and fix problems"
    echo "  rollback   Restore previous snapshot"
    echo ""
    tui_subtitle "Options:"
    echo "  -y, --yes     Skip prompts (auto-yes)"
    echo "  -q, --quiet   Minimal output"
    echo "  -h, --help    Show this help"
    echo ""
    tui_subtitle "Examples:"
    echo "  ./setup              # Interactive menu"
    echo "  ./setup update       # Check for updates and apply"
    echo "  ./setup doctor       # Fix common issues"
    echo "  ./setup rollback     # Restore previous state"
    echo ""
}

###############################################################################
# Version Status Display
###############################################################################
show_version_info() {
    local installed_ver=$(get_installed_version)
    local installed_commit=$(get_installed_commit)
    local repo_ver=$(get_repo_version)
    local repo_commit=$(get_repo_commit)
    
    echo ""
    tui_status_line "Installed:" "$installed_ver ($installed_commit)" "ok"
    tui_status_line "Available:" "$repo_ver ($repo_commit)" ""
    
    # Check for pending migrations
    local pending=$(count_pending_migrations 2>/dev/null || echo "0")
    if [[ "$pending" -gt 0 ]]; then
        tui_status_line "Migrations:" "$pending pending" "warn"
    fi
    
    # Check for updates
    if [[ "$installed_commit" != "$repo_commit" ]]; then
        echo ""
        tui_warn "Update available"
    fi
}

###############################################################################
# TUI Menu
###############################################################################
tui_menu() {
    clear
    tui_banner
    
    # Detect current state
    local is_installed=false
    [[ -f "${XDG_CONFIG_HOME}/illogical-impulse/installed_true" ]] && is_installed=true
    
    if $is_installed; then
        show_version_info
        echo ""
        tui_divider
    fi
    
    echo ""
    
    # Menu options based on state
    local choice
    if $is_installed; then
        choice=$(tui_choose "What would you like to do?" \
            "Update" "Doctor" "Rollback" "Reinstall" "Status" "Help" "Exit")
    else
        choice=$(tui_choose "What would you like to do?" \
            "Install" "Help" "Exit")
    fi
    
    case "$choice" in
        Install|Reinstall) run_install ;;
        Update) run_update ;;
        Doctor) run_doctor ;;
        Rollback) run_rollback ;;
        Status) show_status; read -p "Press Enter to continue..." ;;
        Help) show_help; read -p "Press Enter to continue..." ;;
        *) exit 0 ;;
    esac
}

###############################################################################
# Status Command
###############################################################################
show_status() {
    echo ""
    tui_title "ii-niri Status"
    echo ""
    
    local installed_ver=$(get_installed_version)
    local installed_commit=$(get_installed_commit)
    local repo_ver=$(get_repo_version)
    local repo_commit=$(get_repo_commit)
    
    tui_table_header "Property" "Value"
    tui_table_row "Version" "$installed_ver"
    tui_table_row "Commit" "$installed_commit"
    tui_table_row "Repo Version" "$repo_ver"
    tui_table_row "Repo Commit" "$repo_commit"
    tui_table_footer
    
    echo ""
    
    # Check shell status
    if pgrep -f "qs.*-c.*ii" &>/dev/null; then
        tui_success "Shell is running"
    else
        tui_warn "Shell is not running"
    fi
    
    # Check Niri
    if [[ -n "$NIRI_SOCKET" ]]; then
        tui_success "Niri compositor detected"
    else
        tui_warn "Not running in Niri session"
    fi
    
    # Pending migrations
    local pending=$(count_pending_migrations 2>/dev/null || echo "0")
    if [[ "$pending" -gt 0 ]]; then
        echo ""
        tui_warn "$pending pending migration(s)"
        tui_info "Run './setup update' to review"
    fi
    
    # Snapshots
    local snapshot_count=$(list_snapshots 2>/dev/null | wc -l)
    if [[ "$snapshot_count" -gt 0 ]]; then
        echo ""
        tui_info "$snapshot_count snapshot(s) available for rollback"
    fi
}

###############################################################################
# Install
###############################################################################
run_install() {
    detect_distro
    
    # Greeting & system info
    source ./sdata/subcmd-install/0.greeting.sh
    
    # Check conflicts
    check_conflicts
    
    # 1. Dependencies
    if [[ "${SKIP_DEPS}" != "true" ]]; then
        tui_step 1 3 "Installing dependencies"
        source ./sdata/subcmd-install/1.deps-router.sh
    fi
    
    # 2. System setup (groups, services)
    if [[ "${SKIP_SETUPS}" != "true" ]]; then
        tui_step 2 3 "System configuration"
        source ./sdata/subcmd-install/2.setups.sh
    fi
    
    # 3. Config files
    if [[ "${SKIP_FILES}" != "true" ]]; then
        tui_step 3 3 "Installing config files"
        source ./sdata/subcmd-install/3.files.sh
    fi
    
    # Set version tracking
    set_installed_version "$(get_repo_version)" "$(get_repo_commit)" "setup"
}

###############################################################################
# Update
###############################################################################
run_update() {
    echo ""
    tui_title "Checking for updates..."
    echo ""
    
    if check_remote_updates; then
        show_pending_commits
        
        if $ask; then
            if ! tui_confirm "Pull and apply these updates?"; then
                echo "Cancelled."
                return 0
            fi
        fi
        
        # Create snapshot BEFORE pulling
        tui_info "Creating snapshot..."
        local remote_commit=$(get_remote_commit)
        local snapshot_id=$(create_snapshot "update" "Before update to ${remote_commit}" "$remote_commit")
        tui_success "Snapshot: $snapshot_id"
        
        # Pull changes
        tui_info "Pulling changes..."
        if ! git -C "$REPO_ROOT" pull --ff-only origin 2>/dev/null; then
            tui_error "Git pull failed. You may have local changes."
            tui_info "Try: git stash && ./setup update"
            return 1
        fi
        tui_success "Changes pulled"
    else
        # Check if local repo is ahead of installed
        local installed_ver=$(get_installed_version)
        local installed_commit=$(get_installed_commit)
        local repo_ver=$(get_repo_version)
        local repo_commit=$(get_repo_commit)
        
        if [[ "$installed_ver" == "0.0.0" ]] && [[ -f "${XDG_CONFIG_HOME}/illogical-impulse/installed_true" ]]; then
            tui_info "Detected existing installation without version tracking"
        elif [[ "$installed_commit" == "$repo_commit" ]]; then
            tui_success "Already up to date ($installed_ver)"
            
            local pending=$(count_pending_migrations)
            if [[ "$pending" -gt 0 ]]; then
                echo ""
                tui_warn "$pending pending migration(s) available"
                if $ask && tui_confirm "Apply migrations now?"; then
                    run_migrations_interactive
                fi
            fi
            return 0
        else
            # Local repo ahead of installed - create snapshot
            tui_info "Creating snapshot..."
            local snapshot_id=$(create_snapshot "update" "Before sync to ${repo_commit}" "$repo_commit")
            tui_success "Snapshot: $snapshot_id"
        fi
    fi
    
    # Sync files
    local repo_ver=$(get_repo_version)
    local repo_commit=$(get_repo_commit)
    
    echo ""
    tui_info "Syncing ii-niri..."
    
    II_SOURCE="${REPO_ROOT}"
    II_TARGET="${XDG_CONFIG_HOME}/quickshell/ii"
    
    # Check if source and target are the same (dev setup)
    local src_real=$(realpath "$II_SOURCE" 2>/dev/null || echo "$II_SOURCE")
    local tgt_real=$(realpath "$II_TARGET" 2>/dev/null || echo "$II_TARGET")
    
    if [[ "$src_real" != "$tgt_real" ]]; then
        # Sync root QML files
        for qml in "${II_SOURCE}"/*.qml; do
            [[ -f "$qml" ]] && cp -f "$qml" "${II_TARGET}/$(basename "$qml")"
        done
        
        # Sync directories
        for dir in modules services scripts assets translations; do
            [[ -d "${II_SOURCE}/${dir}" ]] && rsync -a --delete "${II_SOURCE}/${dir}/" "${II_TARGET}/${dir}/"
        done
        
        # Sync other files
        [[ -f "${II_SOURCE}/requirements.txt" ]] && cp -f "${II_SOURCE}/requirements.txt" "${II_TARGET}/"
    fi
    
    # Generate manifest
    generate_manifest "$II_SOURCE" "${II_TARGET}/.ii-manifest"
    
    # Fix permissions
    find "$II_TARGET/scripts" \( -name "*.sh" -o -name "*.fish" -o -name "*.py" \) -exec chmod +x {} \; 2>/dev/null || true
    
    # Update version
    set_installed_version "$repo_ver" "$repo_commit" "update"
    
    tui_success "Files synced"
    
    # Migrations
    local pending=$(count_pending_migrations)
    if [[ "$pending" -gt 0 ]]; then
        echo ""
        tui_warn "$pending optional migration(s) available"
        if $ask && tui_confirm "Review and apply?"; then
            run_migrations_interactive
        fi
    fi
    
    # Restart shell
    echo ""
    tui_info "Restarting shell..."
    qs kill -c ii 2>/dev/null || true
    sleep 1
    nohup qs -c ii >/dev/null 2>&1 &
    disown
    tui_success "Shell restarted"
    
    echo ""
    tui_subtitle "Tip: Run './setup rollback' if something breaks"
}

###############################################################################
# Doctor
###############################################################################
run_doctor() {
    echo ""
    tui_title "ii-niri Doctor"
    echo ""
    run_doctor_with_fixes
}

###############################################################################
# Parse args
###############################################################################
COMMAND=""
while [[ $# -gt 0 ]]; do
    case $1 in
        install) COMMAND="install"; shift ;;
        update) COMMAND="update"; shift ;;
        doctor) COMMAND="doctor"; shift ;;
        rollback) COMMAND="rollback"; shift ;;
        status) COMMAND="status"; shift ;;
        -y|--yes) ask=false; shift ;;
        -q|--quiet) quiet=true; shift ;;
        -h|--help) show_help; exit 0 ;;
        *) echo "Unknown: $1"; show_help; exit 1 ;;
    esac
done

###############################################################################
# Run
###############################################################################
case "$COMMAND" in
    install) run_install ;;
    update) run_update ;;
    doctor) run_doctor ;;
    rollback) run_rollback ;;
    status) show_status ;;
    "") tui_menu ;;
esac
